<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>JWT HttpOnly Cookie Test</title>
</head>
<body>
<h1>JWT HttpOnly 쿠키 인증 테스트</h1>

<h2>1. 로그인 (토큰 받기)</h2>
<input type="text" id="username" value="user" placeholder="Username">
<input type="password" id="password" value="pass" placeholder="Password">
<button onclick="login()">로그인</button>
<p id="login-status"></p>

<hr>

<h2>2. 보호된 리소스 요청 (토큰 사용)</h2>
<p>브라우저 개발자 도구 -> Network 탭을 확인하세요. <br>요청 헤더에 'Cookie: access_token=...' 이 자동으로 담겨 나갑니다.</p>
<button onclick="fetchSecureData()">Secure API 호출</button>
<p id="secure-status"></p>

<hr>

<h2>3. JS로 쿠키 접근 시도 (HttpOnly 테스트)</h2>
<p>콘솔을 확인하세요. HttpOnly 때문에 토큰을 읽을 수 없습니다.</p>
<button onclick="testHttpOnly()">JS 쿠키 접근 시도</button>

<script>
  const API_BASE = '/api/auth';

  // 1. 로그인 함수
  async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const statusEl = document.getElementById('login-status');

    try {
      const response = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const text = await response.text();

      if (response.ok) {
        statusEl.style.color = 'green';
        statusEl.innerHTML = `성공: ${text} <br> **브라우저에 HttpOnly 쿠키가 자동 저장되었습니다.**`;
      } else {
        statusEl.style.color = 'red';
        statusEl.textContent = `실패: ${text}`;
      }

    } catch (error) {
      statusEl.style.color = 'red';
      statusEl.textContent = `오류 발생: ${error.message}`;
    }
  }

  // 2. 보호된 API 요청 함수 (토큰 자동 사용)
  async function fetchSecureData() {
    const statusEl = document.getElementById('secure-status');

    try {
      // 프론트 코드 어디에도 토큰을 수동으로 꺼내 헤더에 넣는 로직이 없음!
      const response = await fetch(`${API_BASE}/secure`, {
        method: 'GET'
        // 브라우저가 저장된 쿠키(JWT)를 'Cookie' 헤더에 자동 첨부
      });

      const text = await response.text();

      if (response.ok) {
        statusEl.style.color = 'green';
        statusEl.innerHTML = `성공: ${text}`;
      } else {
        statusEl.style.color = 'red';
        statusEl.textContent = `실패: ${text}`;
      }

    } catch (error) {
      statusEl.style.color = 'red';
      statusEl.textContent = `오류 발생: ${error.message}`;
    }
  }

  // 3. HttpOnly 테스트 함수
  function testHttpOnly() {
    const cookies = document.cookie;
    console.log("현재 JS가 접근 가능한 쿠키:", cookies);
    if (cookies.includes('access_token')) {
      console.error("오류: access_token이 보인다는 것은 HttpOnly 설정이 실패했다는 뜻입니다!");
    } else {
      console.log("성공: access_token은 보이지 않습니다. HttpOnly 속성이 정상 작동하고 있습니다.");
    }
  }

</script>
</body>
</html>